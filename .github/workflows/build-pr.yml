---
name: build-pr
on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build'
        required: true
        default: 'main'
      platform:
        description: 'Platform to build'
        required: true
        type: choice
        default: 'android'
        options:
          - ios
          - android
          - both

  pull_request:
    types:
      - labeled

# Limit permissions of the GITHUB_TOKEN
permissions:
  contents: read
  pull-requests: write
  actions: write

env:
  NODE_VERSION: 22.14.0
  TERM: xterm
  # Consistent ref for checkout: PR's head SHA, or the ref the workflow_dispatch runs on.
  CHECKOUT_REF: ${{ github.event.pull_request.head.sha || github.ref }}
  # Branch to build: PR's head ref (branch name) or the input branch for workflow_dispatch
  BRANCH_TO_BUILD: ${{ github.event.pull_request.head.ref || github.event.inputs.branch }}

jobs:
  # test:
  #   if: ${{ (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch') }}
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - name: ci/checkout-repo
  #       uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
  #       with:
  #         ref: ${{ env.CHECKOUT_REF }}
  #     - name: ci/test
  #       uses: ./.github/actions/test

  build-ios-pr:
    runs-on: macos-14-large
    # needs: test
    if: |
      (
        github.event.label.name == 'Build Apps for PR' || 
        github.event.label.name == 'Build App for iOS' || 
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both'))
      ) && 
      (github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.fork != true)
    env:
      AWS_ACCESS_KEY_ID: "${{ secrets.MM_MOBILE_PR_AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY: "${{ secrets.MM_MOBILE_PR_AWS_SECRET_ACCESS_KEY }}"
      FASTLANE_TEAM_ID: "${{ secrets.MM_MOBILE_FASTLANE_TEAM_ID }}"
      IOS_API_ISSUER_ID: "${{ secrets.MM_MOBILE_IOS_API_ISSUER_ID }}"
      IOS_API_KEY: "${{ secrets.MM_MOBILE_IOS_API_KEY }}"
      IOS_API_KEY_ID: "${{ secrets.MM_MOBILE_IOS_API_KEY_ID }}"
      MATCH_GIT_URL: "${{ secrets.MM_MOBILE_MATCH_GIT_URL }}"
      MATCH_PASSWORD: "${{ secrets.MM_MOBILE_MATCH_PASSWORD }}"
      MATTERMOST_WEBHOOK_URL: "${{ secrets.MM_MOBILE_PR_MATTERMOST_WEBHOOK_URL }}"
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: ci/prepare-ios-build
        uses: ./.github/actions/prepare-ios-build

      - name: ci/output-ssh-private-key
        shell: bash
        run: |
          SSH_KEY_PATH=~/.ssh/id_ed25519
          mkdir -p ~/.ssh
          echo -e '${{ secrets.MM_MOBILE_PRIVATE_DEPLOY_KEY }}' > ${SSH_KEY_PATH}
          chmod 0600 ${SSH_KEY_PATH}
          ssh-keygen -y -f ${SSH_KEY_PATH} > ${SSH_KEY_PATH}.pub

      - name: ci/build-ios-pr
        env:
          GITHUB_PR_NUMBER: "${{ github.event.pull_request.number }}"
          GITHUB_EVENT_NAME: "${{ github.event_name }}"
          BRANCH_TO_BUILD: "${{ env.BRANCH_TO_BUILD }}"
        run: bundle exec fastlane ios build --env ios.pr
        working-directory: ./fastlane

      - name: ci/upload-ios-pr-build
        id: ci-upload-ios-pr-build
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ios-build-pr-${{ github.run_id }}
          path: "*.ipa"

      - name: ci/post-artifact-link-to-pr
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';
            const installUrl = `itms-services://?action=download-manifest&url=https://pr-builds.mattermost.com/mattermost-mobile/${prNumber}/merge/Mattermost_Beta.plist`;
            const message = `### iOS PR Build\n\nYou can install the iOS app directly from:\n- [Install from PR Builds](${installUrl})\n\nCommit: ${{ env.CHECKOUT_REF }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  build-android-pr:
    runs-on: ubuntu-22.04
    # needs: test
    if: |
      (
        github.event.label.name == 'Build Apps for PR' || 
        github.event.label.name == 'Build App for Android' || 
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both'))
      ) && 
      (github.event_name == 'workflow_dispatch' || github.event.pull_request.head.repo.fork != true)
    env:
      AWS_ACCESS_KEY_ID: "${{ secrets.MM_MOBILE_PR_AWS_ACCESS_KEY_ID }}"
      AWS_SECRET_ACCESS_KEY: "${{ secrets.MM_MOBILE_PR_AWS_SECRET_ACCESS_KEY }}"
      MATTERMOST_WEBHOOK_URL: "${{ secrets.MM_MOBILE_PR_MATTERMOST_WEBHOOK_URL }}"
    steps:
      - name: ci/checkout-repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ env.CHECKOUT_REF }}

      - name: ci/prepare-android-build
        uses: ./.github/actions/prepare-android-build
        env:
          STORE_FILE: "${{ secrets.MM_MOBILE_STORE_FILE }}"
          STORE_ALIAS: "${{ secrets.MM_MOBILE_STORE_ALIAS }}"
          STORE_PASSWORD: "${{ secrets.MM_MOBILE_STORE_PASSWORD }}"
          MATTERMOST_BUILD_GH_TOKEN: "${{ secrets.MATTERMOST_BUILD_GH_TOKEN }}"

      - name: ci/build-android-pr
        env:
          GITHUB_PR_NUMBER: "${{ github.event.pull_request.number }}"
          GITHUB_EVENT_NAME: "${{ github.event_name }}"
          BRANCH_TO_BUILD: "${{ env.BRANCH_TO_BUILD }}"
        run: bundle exec fastlane android build --env android.pr
        working-directory: ./fastlane

      - name: ci/upload-android-pr-build
        id: ci-upload-android-pr-build
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: android-build-pr-${{ github.run_id }}
          path: "*.apk"

      - name: ci/post-artifact-link-to-pr
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = '${{ github.event.pull_request.number }}';
            const installUrl = `https://pr-builds.mattermost.com/mattermost-mobile/${prNumber}/merge/Mattermost_Beta.apk`;
            const message = `### iOS PR Build\n\nYou can install the iOS app directly from:\n- [Install from PR Builds](${installUrl})\n- Or copy this URL: \`${installUrl}\`\n\nCommit: ${{ env.CHECKOUT_REF }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  redirect-fork-build:
    runs-on: ubuntu-22.04
    if: |
      (
        github.event.label.name == 'Build Apps for PR' || 
        github.event.label.name == 'Build App for iOS' || 
        github.event.label.name == 'Build App for Android' || 
        (github.event_name == 'workflow_dispatch' && github.event.inputs.platform != '')
      ) && 
      github.event_name == 'pull_request' && 
      github.event.pull_request.head.repo.fork == true
    steps:
      - name: ci/determine-platform
        id: determine-platform
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PLATFORM="${{ github.event.inputs.platform }}"
          elif [[ "${{ github.event.label.name }}" == "Build App for iOS" ]]; then
            PLATFORM="ios"
          elif [[ "${{ github.event.label.name }}" == "Build App for Android" ]]; then
            PLATFORM="android"
          else
            PLATFORM="both"
          fi
          echo "platform=${PLATFORM}" >> $GITHUB_OUTPUT
          echo "Determined platform: ${PLATFORM}"

      - name: ci/trigger-fork-workflow
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowId = 'build-fork-pr.yml';
            const platformInput = '${{ steps.determine-platform.outputs.platform }}';
            const prHeadRef = '${{ github.event.pull_request.head.ref }}';
            const prNumber = '${{ github.event.pull_request.number }}';

            console.log(`Triggering fork build workflow for PR #${prNumber}`);
            console.log(`Branch: ${prHeadRef}, Platform: ${platformInput}`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.payload.pull_request.head.repo.owner.login,
              repo: context.payload.pull_request.head.repo.name,
              workflow_id: workflowId,
              ref: prHeadRef,
              inputs: {
                branch: prHeadRef,
                platform: platformInput
              }
            });

            console.log(`Successfully triggered fork build workflow`);

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `### Fork PR Build Triggered ðŸš€\n\nA separate workflow (**${workflowId}**) has been triggered to build this PR from the forked repository.\n\n**Details:**\n- Platform: **${platformInput}**\n- Branch: **${prHeadRef}**\n- PR: #${prNumber}\n\nThis may take a few minutes to complete. You'll receive another comment when the build is ready.`
            });
